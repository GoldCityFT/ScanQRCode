<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>สแกน QR Code</title>
  <!-- ใช้ library สแกน QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #43cea2, #185a9d);
      color: white;
    }
    h2 { margin-bottom: 20px; }
    #reader { width: 300px; margin: auto; }
  </style>
</head>
<body>
  <h2>สแกน QR Code</h2>
  <div id="reader"></div>

  <script>
    async function main() {
      const html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          // qrCodeMessage คือรหัสจาก QR Code ทั้งหมด
          const trackingCode = qrCodeMessage.trim();

          if (!trackingCode) {
            alert("QR Code ไม่ถูกต้อง กรุณาสแกนใหม่");
            return;
          }

          // บันทึกลง Google Sheets
          fetch("https://script.google.com/macros/s/AKfycbyklv9SQB7L2WdrTjHRuwZkm9UB0zime9s8v8gutC2p3VcVPQB1Pd3I8rZoQA_v63zx/exec", {
            method: "POST",
            body: new URLSearchParams({
              token: "Gl0D$Yt1@",
              Tracking: trackingCode
            })
          })
          .then(res => res.text())
          .then(data => {
            alert("Scan QRCODE เรียบร้อยแล้ว!");
            // redirect ไป Form.html
            window.location.href = "Form.html";
          })
          .catch(err => {
            console.error("Save error:", err);
            alert("เกิดข้อผิดพลาดในการ Scan QRCODE");
          });

          // หยุดสแกน
          html5QrCode.stop();
        },
        errorMessage => {
          console.log("Scanning...", errorMessage);
        }
      ).catch(err => {
        console.error("Camera start error:", err);
        alert("ไม่สามารถเปิดกล้องได้");
      });
    }

    main();
  </script>
</body>
</html>
